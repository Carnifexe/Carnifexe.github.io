<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pong Multiplayer</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #000;
            color: white;
            font-family: Arial, sans-serif;
        }
        canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9999;
            display: none;
            background: #000;
        }
        #startButton {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            padding: 20px;
            font-size: 20px;
            cursor: pointer;
            z-index: 10001;
            background: #333;
            color: white;
            border: none;
            border-radius: 5px;
        }
        #scoreboard {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10000;
            color: white;
            background: rgba(0,0,0,0.5);
            padding: 15px 30px;
            border-radius: 10px;
            text-align: center;
            display: none;
        }
        #waitingText {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            color: white;
            z-index: 10003;
            display: none;
            text-align: center;
            background: rgba(0,0,0,0.7);
            padding: 20px;
            border-radius: 10px;
        }
        #connectedClients {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 20px;
            color: white;
            z-index: 10002;
        }
    </style>
</head>
<body>
    <div id="waitingText">Warte auf Gegner...</div>
    <div id="connectedClients">Verbunden: 0 Spieler</div>
    <div id="scoreboard">Spieler 1: 0 | Spieler 2: 0</div>
    <button id="startButton">Pong starten</button>
    <canvas id="pongCanvas"></canvas>

    <script>
        // 1. Initialisierung
        const socket = new WebSocket('ws://localhost:8080');
        const canvas = document.getElementById("pongCanvas");
        const ctx = canvas.getContext("2d");
        const startButton = document.getElementById("startButton");
        const waitingText = document.getElementById("waitingText");
        const connectedClients = document.getElementById("connectedClients");
        const scoreboard = document.getElementById("scoreboard");

        // 2. Spielvariablen
        let gameRunning = false;
        let playerNumber = null;
        let player1Score = 0;
        let player2Score = 0;
        
        // Pong-Elemente
        const paddleWidth = 15;
        const paddleHeight = 100;
        const ballSize = 10;
        let player1Y = 0;
        let player2Y = 0;
        let ballX = 0;
        let ballY = 0;
        let ballSpeedX = 0;
        let ballSpeedY = 0;

        // 3. Canvas Setup
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            // Initialpositionen setzen
            player1Y = canvas.height / 2 - paddleHeight / 2;
            player2Y = canvas.height / 2 - paddleHeight / 2;
            resetBall();
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // 4. WebSocket-Handler
        socket.onopen = () => {
            console.log("Verbunden!");
            socket.send(JSON.stringify({ type: "getPlayers" }));
        };

        socket.onmessage = (event) => {
            const data = JSON.parse(event.data);
            console.log("Empfangen:", data.type);

            if (data.type === "updatePlayerCount") {
                connectedClients.textContent = `Verbunden: ${data.count} Spieler`;
            }

            if (data.type === "gameStart") {
                playerNumber = data.playerNumber;
                console.log("Ich bin Spieler", playerNumber);
                waitingText.style.display = "none";
                scoreboard.style.display = "block";
                startGame();
            }

            if (data.type === "paddleMove") {
                if (data.player === 1) player1Y = data.y;
                if (data.player === 2) player2Y = data.y;
            }

            if (data.type === "ballUpdate") {
                ballX = data.x;
                ballY = data.y;
                ballSpeedX = data.speedX;
                ballSpeedY = data.speedY;
            }

            if (data.type === "scoreUpdate") {
                player1Score = data.player1;
                player2Score = data.player2;
                scoreboard.textContent = `Spieler 1: ${player1Score} | Spieler 2: ${player2Score}`;
            }
        };

        // 5. Spielsteuerung
        startButton.addEventListener("click", () => {
            startButton.style.display = "none";
            waitingText.style.display = "block";
            socket.send(JSON.stringify({ type: "ready" }));
        });

        document.addEventListener('keydown', (e) => {
            if (!gameRunning) return;

            const paddleSpeed = 20;
            let newY;

            // Spieler 1 (W/S)
            if (playerNumber === 1 && (e.key === 'w' || e.key === 's')) {
                newY = e.key === 'w' ? player1Y - paddleSpeed : player1Y + paddleSpeed;
                player1Y = Math.max(0, Math.min(canvas.height - paddleHeight, newY));
                socket.send(JSON.stringify({ 
                    type: "paddleMove", 
                    player: 1, 
                    y: player1Y 
                }));
            }

            // Spieler 2 (Pfeiltasten)
            if (playerNumber === 2 && (e.key === 'ArrowUp' || e.key === 'ArrowDown')) {
                newY = e.key === 'ArrowUp' ? player2Y - paddleSpeed : player2Y + paddleSpeed;
                player2Y = Math.max(0, Math.min(canvas.height - paddleHeight, newY));
                socket.send(JSON.stringify({ 
                    type: "paddleMove", 
                    player: 2, 
                    y: player2Y 
                }));
            }
        });

        // 6. Spiel-Logik
        function resetBall() {
            ballX = canvas.width / 2;
            ballY = canvas.height / 2;
            ballSpeedX = 5 * (Math.random() > 0.5 ? 1 : -1);
            ballSpeedY = 5 * (Math.random() > 0.5 ? 1 : -1);
        }

        function draw() {
            // Hintergrund
            ctx.fillStyle = "#000";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Paddles
            ctx.fillStyle = "#fff";
            ctx.fillRect(0, player1Y, paddleWidth, paddleHeight);
            ctx.fillRect(canvas.width - paddleWidth, player2Y, paddleWidth, paddleHeight);

            // Ball
            ctx.beginPath();
            ctx.arc(ballX, ballY, ballSize, 0, Math.PI * 2);
            ctx.fill();

            // Mittellinie
            ctx.strokeStyle = "#333";
            ctx.setLineDash([10, 10]);
            ctx.beginPath();
            ctx.moveTo(canvas.width / 2, 0);
            ctx.lineTo(canvas.width / 2, canvas.height);
            ctx.stroke();
            ctx.setLineDash([]);
        }

        function gameLoop() {
            if (!gameRunning) return;

            draw();
            requestAnimationFrame(gameLoop);
        }

        function startGame() {
            gameRunning = true;
            canvas.style.display = "block";
            resetBall();
            gameLoop();
        }
    </script>
</body>
</html>
