<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pong Multiplayer</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #000;
            color: white;
            font-family: Arial, sans-serif;
        }
        canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: none;
        }
        #queueButton {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            padding: 20px;
            font-size: 20px;
            cursor: pointer;
            background: #333;
            color: white;
            border: none;
            border-radius: 5px;
        }
        #waitingText {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            color: white;
            display: none;
            text-align: center;
            background: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border-radius: 10px;
        }
        #connectedClients {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 20px;
            color: white;
        }
    </style>
</head>
<body>
    <div id="waitingText">Warte auf Gegner...</div>
    <div id="connectedClients">Verbunden: 0 Spieler</div>
    <button id="queueButton">Warteschlange beitreten</button>
    <canvas id="pongCanvas"></canvas>

    <script>
        const socket = new WebSocket('wss://carnifexe-github-io.onrender.com');
        const canvas = document.getElementById("pongCanvas");
        const ctx = canvas.getContext("2d");
        const queueButton = document.getElementById("queueButton");
        const waitingText = document.getElementById("waitingText");
        const connectedClients = document.getElementById("connectedClients");

        let playerNumber = null;
        let opponent = null;
        let gameRunning = false;
        let playerY = canvas.height / 2 - 50;
        let opponentY = canvas.height / 2 - 50;
        let ballX = canvas.width / 2, ballY = canvas.height / 2;
        let ballSpeedX = 5, ballSpeedY = 5;

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        socket.onopen = () => {
            console.log("Mit Server verbunden");
        };

        socket.onmessage = (event) => {
            const data = JSON.parse(event.data);
            
            if (data.type === "queueUpdate") {
                connectedClients.textContent = `Warteschlange: ${data.count} Spieler`;
            }

            if (data.type === "gameStart") {
                playerNumber = data.playerNumber;
                opponent = data.opponent;
                console.log(`Spiel gestartet als Spieler ${playerNumber}`);
                queueButton.style.display = "none";
                waitingText.style.display = "none";
                canvas.style.display = "block";
                gameRunning = true;
                gameLoop();
            }

            if (data.type === "paddleMove" && data.player !== playerNumber) {
                opponentY = data.y;
            }

            if (data.type === "ballUpdate") {
                ballX = data.x;
                ballY = data.y;
                ballSpeedX = data.speedX;
                ballSpeedY = data.speedY;
            }
        };

        queueButton.addEventListener("click", () => {
            queueButton.style.display = "none";
            waitingText.style.display = "block";
            socket.send(JSON.stringify({ type: "joinQueue" }));
        });

        canvas.addEventListener("mousemove", (e) => {
            if (!gameRunning) return;
            
            const rect = canvas.getBoundingClientRect();
            playerY = e.clientY - rect.top - 50;
            playerY = Math.max(0, Math.min(canvas.height - 100, playerY));

            socket.send(JSON.stringify({ type: "paddleMove", player: playerNumber, y: playerY }));
        });

        function gameLoop() {
            if (!gameRunning) return;

            ballX += ballSpeedX;
            ballY += ballSpeedY;

            if (ballY <= 0 || ballY >= canvas.height) ballSpeedY *= -1;

            if ((ballX <= 15 && ballY >= playerY && ballY <= playerY + 100) ||
                (ballX >= canvas.width - 15 && ballY >= opponentY && ballY <= opponentY + 100)) {
                ballSpeedX *= -1;
            }

            if (ballX < 0 || ballX > canvas.width) {
                ballX = canvas.width / 2;
                ballY = canvas.height / 2;
                ballSpeedX = 5 * (Math.random() > 0.5 ? 1 : -1);
                ballSpeedY = 5 * (Math.random() > 0.5 ? 1 : -1);
            }

            draw();

            if (playerNumber === 1) {
                socket.send(JSON.stringify({
                    type: "ballUpdate",
                    x: ballX,
                    y: ballY,
                    speedX: ballSpeedX,
                    speedY: ballSpeedY
                }));
            }

            requestAnimationFrame(gameLoop);
        }

        function draw() {
            ctx.fillStyle = "#000";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.strokeStyle = "#333";
            ctx.beginPath();
            ctx.moveTo(canvas.width / 2, 0);
            ctx.lineTo(canvas.width / 2, canvas.height);
            ctx.stroke();

            ctx.fillStyle = "#fff";
            ctx.fillRect(0, playerY, 15, 100);
            ctx.fillRect(canvas.width - 15, opponentY, 15, 100);

            ctx.beginPath();
            ctx.arc(ballX, ballY, 10, 0, Math.PI * 2);
            ctx.fill();
        }
    </script>
</body>
</html>
